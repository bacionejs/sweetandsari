<html> <script>


onload=()=>{

window.onerror=(msg,_,line,col)=>{
alert(`Error: ${msg} at ${line}:${col}`);
return true;
};

let DB_NAME="bacionejs.sweetandsari31";
let STORE="inventory";
let LOG="log";
let cart={};
let db;

element("style").textContent=getstyles();
element("div").id="banner";
let con=element("div");
document.title               ="Sweet & Sari";
element("h2",con).textContent="Sweet & Sari";
createtabs(con);
initDB();

function initDB(){
let request=indexedDB.open(DB_NAME);
request.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains(STORE)){db.createObjectStore(STORE,{keyPath:"name"});}
  if(!db.objectStoreNames.contains(LOG)){db.createObjectStore(LOG,{keyPath: 'id', autoIncrement: true});}
};
request.onsuccess=e=>{
  db=e.target.result;
  showMaster("Sell");
};
request.onerror=()=>alert("Error loading database.");
}

function createtabs(parent){
let buttons=element("div",parent,"MasterButtons");
let tabs=element("div",parent,"MasterTabs");
["Buy","Sell","Reports","Inventory","Log","Database"].forEach(tab=>{element("button",buttons,tab+"btn",tab,()=>showMaster(tab));});
element("div",tabs,"Buy").classList="tab transaction";
element("div",tabs,"Sell").classList="tab transaction";
element("div",tabs,"Inventory").className="tab";
element("div",tabs,"Log").className="tab";
element("div",tabs,"Reports").className="tab";
let dbTab=element("div",tabs,"Database");
dbTab.className="tab";
element("p",dbTab,null,"Warning: This will clear all data from Sweet and Sari.");
element("button",dbTab,null,"Clear Data",clearStores);
}

function createTransaction(tabname){
let tab=document.getElementById(tabname);
createTable(tab,"transactionTable",["Item","Cost","Price","Stock","Qty"]);
let form=element("div",tab,"paymentForm");
element("h3",form).textContent="Payment Form";
createTable(form,"paymentSummary",["Name","Cost","Price","Qty","Subtotal"]);
element("h3",form).innerHTML="Total: $<span id=summaryTotalPrice>0.00</span> | Items: <span id=summaryTotalItems>0</span>";
element("button",form,"","Process Payment",()=>processPayment(tabname));
form.appendChild(document.createTextNode(" "));
element("button",form,"","Cancel",cancelPayment);
loadTransaction(tabname);
}

function loadTransaction(type){
let store=db.transaction(STORE,"readonly").objectStore(STORE);
let tbody=document.querySelector("#transactionTable tbody");
document.getElementById("paymentForm").style.display="none";
tbody.innerHTML="";
store.openCursor().onsuccess=e=>{let cursor=e.target.result;if(cursor){
  let item=cursor.value;
  let row=element("tr",tbody);
  ["name","cost","price","stock"].forEach(field=>element("td",row,"",item[field]));
  let td=element("td",row);
  let minus=element("button",td,"","-",()=>minusplus(item.name,-1,type));
  minus.className="small-btn";
  let input=element("input",td,`transactionQty-${item.name}`);
  input.type="number";
  input.value=0;
  input.min=0;
  input.max=item.stock;
  input.style.width="3ch";
  input.addEventListener("input",()=>updateTransaction(item.name,parseInt(input.value),type));
  let plus=element("button",td,"","+",()=>minusplus(item.name,1,type));
  plus.className="small-btn";
  cursor.continue();
}};
}

function processPayment(type){
let tx=db.transaction(STORE,"readwrite");
let store=tx.objectStore(STORE);
Object.values(cart).forEach(item=>{store.get(item.name).onsuccess=e=>{
  let dbItem=e.target.result;
  if(dbItem){
    dbItem.stock+=(type=="Buy"?1:-1)*item.qty;
    store.put(dbItem);
    log(item.name,dbItem.cost,item.price,item.qty,type);
  }
};});
tx.oncomplete=()=>{
  cart={};
  document.getElementById("paymentForm").style.display="none";
  loadTransaction(type);
};
}

function updateTransaction(name,qty,type){
db.transaction(STORE,"readonly").objectStore(STORE).get(name).onsuccess=e=>{let item=e.target.result;if(item){
  let subtotal;
  if(type=="Buy")subtotal=qty*item.cost;else subtotal=qty*item.price;
  if(qty>0){
    cart[name]={name,cost:item.cost,price:item.price,qty,subtotal};
  }else{
    delete cart[name];
  }
  let totalItems=0,totalPrice=0;
  Object.values(cart).forEach(item=>{totalItems+=item.qty;totalPrice+=item.subtotal;});
  document.getElementById("summaryTotalPrice").textContent=totalPrice.toFixed(2);
  document.getElementById("summaryTotalItems").textContent=totalItems;
  document.getElementById("paymentForm").style.display="block";
  let tbody=document.querySelector("#paymentSummary tbody");
  tbody.innerHTML="";
  Object.values(cart).forEach(item=>{
    let row=element("tr",tbody);
    ["name","cost","price","qty","subtotal"].forEach(field=>{element("td",row,"",field==="subtotal"?item[field].toFixed(2):item[field]);});
  });
}};
}

function createReports(tabname){
let tab=document.getElementById(tabname);
tab.innerHTML="";
let buttons=element("div",tab,"ReportButtons");
let tabs=element("div",tab,"ReportTabs");
["Transactions","Items","Daily","Monthly","Yearly","Summary"].forEach(tab=>{element("button",buttons,tab+"btn",tab,()=>showReport(tab));});
["Transactions","Items","Daily","Monthly","Yearly","Summary"].forEach(tab=>{element("div",tabs,tab,"").className="tab";});
showReport("Transactions");
}

function showReport(tab){
let e=document.getElementById(tab);
e.innerHTML="";
loadReportData().then(data=>{
  if(tab==="Transactions") transactionsreport(e,data);
  if(tab==="Items")     group(e,data,["Item","Buy","Sell","Profit"],["item"]);
  if(tab==="Daily")     group(e,data,[" "   ,"Buy","Sell","Profit"],["year","month","day"]);
  if(tab==="Monthly")   group(e,data,[" "   ,"Buy","Sell","Profit"],["year","month"]);
  if(tab==="Yearly")    group(e,data,[" "   ,"Buy","Sell","Profit"],["year"]);
  if(tab==="Summary")   group(e,data,[""    ,"Buy","Sell","Profit"],["all"]);
}).catch(err=>{console.error("Error loading data:",err);});
toggle("Report",tab)
}

function loadReportData(){
return new Promise((resolve,reject)=>{
let data=[],store=db.transaction(LOG,"readonly").objectStore(LOG);
store.openCursor().onsuccess=e=>{
let cursor=e.target.result;
if(cursor){
  let t=cursor.value;
  let ts=t.timestamp.toString();
  data.push({timestamp:ts,all:"",year:ts.slice(0,4),month:ts.slice(4,6),day:ts.slice(6,8),item:t.item,cost:t.cost,price:t.price,quantity:t.quantity,type:t.type});
  cursor.continue();
}else{
  resolve(data);
}};
store.openCursor().onerror=e=>reject(e);
});
}

function transactionsreport(parent,data){
if(!data.length)return;
let table=createTable(parent,"transactionsTable",["Item","Time","Amount"]);
let tbody=table.querySelector("tbody");
data.sort((a,b)=>b.timestamp-a.timestamp);
data.forEach(t=>{
  let row=element("tr",tbody);
  let time=t.timestamp.replace(/^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/,"$1-$2-$3 $4:$5:$6");
  let amount=(t.type==="Buy")?(-t.cost*t.quantity).toFixed(2):(t.price*t.quantity).toFixed(2);
  element("td",row,null,t.item);
  element("td",row,null,time);
  let a=element("td",row,null,amount);
  a.style.color=amount<0?"red":"green";
  a.style.backgroundColor="#fff8e1";
});
}

function group(parent,data,headers,groupKeys){
let table=element("table",parent);
table.style.height="50vh";
table.style.overflowY="auto";
table.style.display="block";
let thead=element("thead",table);
let headerRow=element("tr",thead);
headers.forEach(v=>{if(v)element("th",headerRow,null,v);});
let itemIndex=[...headerRow.children].findIndex(th=>th.textContent==="Item");
if(itemIndex!==-1){
  let itemTh=headerRow.children[itemIndex];
  itemTh.textContent="";
  let input=element("input",itemTh);
  input.placeholder="Item Filter";
  input.oninput=()=>filter(table,itemIndex,input.value.toLowerCase());
}
let tbody=element("tbody",table);
let grouped=by(data,groupKeys);
let rows=[];
function processGroup(grouped,keys,prefix=""){
  for(let key in grouped){
    let current=grouped[key];
    if(Array.isArray(current)){
      rows.push(sum(current,prefix+key));
    }else{
      processGroup(current,keys.slice(1),prefix+key+"-");
    }
  }
}
processGroup(grouped,groupKeys);
rows.sort((a,b)=>b[0]<a[0]?-1:1);
rows.forEach(rowData=>{
  let row=element("tr",tbody);
  rowData.forEach(v=>{if(v)element("td",row,null,v);});
});
}

function by(array,keys){
return array.reduce((acc,obj)=>{
  let nested=acc;
  for(let i=0;i<keys.length;i++){
    let key=keys[i];
    let val=obj[key].toString();
    nested=nested[val]||(nested[val]=i===keys.length-1?[]:{});
  }
  nested.push(obj);
  return acc;
},{});
}

function sum(data,label){
let buySum=0,transactionSum=0;
for(let t of data){if(t.type==="Buy")buySum+=t.cost*t.quantity;else transactionSum+=t.price*t.quantity;}
return [label,buySum.toFixed(2),transactionSum.toFixed(2),(transactionSum-buySum).toFixed(2)];
}










function createraw(tabname){
let tab=document.getElementById(tabname);
let currentStore=tabname.toLowerCase();
let settings,columns,keyPath;

store("readonly").openCursor().onsuccess=e=>{
let cursor=e.target.result;
if(cursor && cursor.value){
  let objectStore=store("readonly");
  keyPath=objectStore.keyPath || 'id';
  let isAutoIncrement=objectStore.autoIncrement;
  columns=Object.keys(cursor.value).filter(f=>!(isAutoIncrement && f===keyPath));
  settings={columns,sortField:"id",sortOrder:"asc",keyPath};
  renderTable(tab);
}else{
  console.warn("Norecordsfoundtodeterminecolumns.");
}
};

function addNew(table){
let tr=element("tr",table);
columns.forEach(_=>{element("td",tr).contentEditable=true;});
element("button",element("td",tr),"",'\u{2795}',()=>{let o={};store("readwrite").add(parseRow(o,tr)).onsuccess=()=>renderTable(table.parentNode);});//create
}

function renderTable(tab){
tab.innerHTML="";
let container=element("div",tab);
container.style.maxHeight="50vh";
container.style.overflowY="auto";
container.style.border="1px solid #ccc";
container.style.position="relative";
let table=element("table",container);
table.style.width="auto";
let header=element("tr",table);
columns.forEach(col=>{element("button",element("th",header),col,col,()=>toggleSort(col));});
element("th",header).textContent="";
addNew(table);
store("readonly").getAll().onsuccess=e=>{let data=e.target.result;sortData(data);data.forEach(r=>row(table,r));};//read
}

function row(table,data){
let tr=element("tr",table);
columns.forEach(col=>{
  let input=element("td",tr);
  input.contentEditable=true;
  input.textContent=data[col] || '';
  input.onblur=()=>{let o={[keyPath]:data[keyPath]};store("readwrite").put(parseRow(o,tr));};//update
});
element("button",element("td",tr),"","\u{274C}",()=>{store("readwrite").delete(data[keyPath]).onsuccess=()=>renderTable(table.parentNode);});//delete
}

function toggleSort(field){
settings.sortOrder=settings.sortField===field?(settings.sortOrder==="asc"?"desc":"asc"):"asc";
settings.sortField=field;
renderTable(tab);
}

function sortData(data){
data.sort((a,b)=>{
  let valA=a[settings.sortField],valB=b[settings.sortField];
  if(typeof valA==="number" && typeof valB==="number"){
    return settings.sortOrder==="asc"?valA-valB:valB-valA;
  }
  return settings.sortOrder==="asc"?String(valA).localeCompare(String(valB)):String(valB).localeCompare(String(valA));
});
}

function parseRow(o,tr){
columns.forEach((col,i)=>{
  let v=tr.children[i].textContent;
  o[col]=isNaN(v)?v:v.includes('.')?parseFloat(v):parseInt(v);
});
return o;
}

function store(type){
return db.transaction(currentStore,type).objectStore(currentStore);
}

}//endcreateraw










function log(item,cost,price,quantity,type){
let store=db.transaction(LOG,"readwrite").objectStore(LOG);
let time=new Date();
let timestamp="FullYear Month Date Hours Minutes Seconds".split(" ").reduce((s,i)=>s+((time["get"+i]()+(i=="Month")).toString().padStart(2,"0")),"");
store.add({
  item,
  cost,
  price,
  quantity,
  type,
  timestamp
});
}

function sortTable(table,col,ascending){
let tbody=table.querySelector("tbody");
[...tbody.children].sort((a,b)=>{
let valA=parseFloat(a.children[col].textContent)||0;
let valB=parseFloat(b.children[col].textContent)||0;
return ascending?valA-valB:valB-valA;
}).forEach(row=>tbody.appendChild(row));
}

function createfilter(table){
let thead=table.querySelector("thead");
let headerRow=thead.querySelector("tr");
let itemIndex=[...headerRow.children].findIndex(th=>th.textContent==="Item");
if(itemIndex==-1)return;
let itemTh=headerRow.children[itemIndex];
itemTh.textContent="";
let input=element("input",itemTh);
input.placeholder="Item Filter";
input.oninput=()=>filter(table,itemIndex,input.value.toLowerCase());
}

function filter(table,col,value){
let tbody=table.querySelector("tbody");
[...tbody.children].forEach(tr=>{let cell=tr.children[col].textContent.toLowerCase();tr.style.display=cell.includes(value)?"":"none";});
}

function createTable(parent,id,headers){
let container=element("div",parent);
container.style.maxHeight="50vh";
container.style.overflowY="auto";
container.style.border="1px solid #ccc";
container.style.position="relative";
let table=element("table",container,id);
table.style.width="100%";
table.style.borderCollapse="collapse";
table.style.position="relative";
let thead=element("thead",table);
thead.style.position="sticky";
thead.style.top="0";
thead.style.backgroundColor="#f1f1f1";
thead.style.zIndex="10";
let headerRow=element("tr",thead);
headers.forEach(v=>{element("th",headerRow).textContent=v;});
createfilter(table);
let stockIndex=[...headerRow.children].findIndex(th=>th.textContent==="Stock");
if(stockIndex!==-1){
  let stockTh=headerRow.children[stockIndex];
  stockTh.style.cursor="pointer";
  stockTh.innerHTML="Stock &#x25B2;";
  let ascending=true;
  stockTh.onclick=()=>{
    sortTable(table,stockIndex,ascending);
    stockTh.innerHTML=ascending?"Stock &#x25B2;":"Stock &#x25BC;";
    ascending=!ascending;
  };
}
element("tbody",table);
return table;
}

function toggle(parent,tab){
document.querySelectorAll("#"+parent+"Buttons button").forEach(e=>e.classList.remove("active"));
document.querySelectorAll("#"+parent+"Tabs div").forEach(e=>e.classList.remove("active"));
document.querySelectorAll(".transaction").forEach(e=>e.innerHTML="");
document.getElementById(tab+"btn").classList.add("active");
document.getElementById(tab).classList.add("active");
}

function showMaster(tab){
toggle("Master",tab);
if(tab==="Buy"||tab==="Sell")createTransaction(tab);
if(tab==="Inventory"||tab==="Log")createraw(tab);
if(tab==="Reports")createReports(tab);
}

function clearStores(){
let req=indexedDB.open(DB_NAME);
req.onsuccess=(e)=>{
  let tx=e.target.result.transaction([STORE,LOG],"readwrite");
  let invStore=tx.objectStore(STORE);
  let txnStore=tx.objectStore(LOG);
  invStore.clear().onsuccess=()=>console.log(STORE+" cleared.");
  txnStore.clear().onsuccess=()=>console.log(LOG+" cleared.");
  tx.oncomplete=()=>alert("Data cleared successfully.");
};
req.onerror=()=>alert("Error opening database.");
req.onupgradeneeded=()=>alert("Database not found.");
}

function minusplus(name,change,type){
let input=document.getElementById(`transactionQty-${name}`);
let newQty=parseInt(input.value||0)+change;
if(newQty<0)newQty=0;
if(newQty>parseInt(input.max))newQty=parseInt(input.max);
input.value=newQty;
updateTransaction(name,newQty,type);
}

function cancelPayment(){
document.getElementById("paymentForm").style.display="none";
cart={};
loadTransaction();
}

function getstyles(){
return `
body {
  background-color: #3e2723; /* Dark chocolate background */
  color: #efebe9; /* Light cocoa text */
  font-family: sans-serif;
  margin: 0;
  padding: 0;
}
#banner {
  height: 20px;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><path d="M0 10 Q10 -5, 20 10 T40 10 T60 10 T80 10 T100 10 V20 H0 Z" fill="%23795548"/><path d="M0 10 Q10 25, 20 10 T40 10 T60 10 T80 10 T100 10 V20 H0 Z" fill="%23a1887f"/></svg>') repeat-x;
}
button {
  background-color: #6d4c41;
  color: #efebe9;
  border: none;
  padding: 5px 10px;
}
button.active {
  background-color: #8d6e63;
  color: #fff8e1;
}
.tab {
  padding: 5px 10px;
  background-color: #8d6e63;
  color: #fff8e1;
  display:none;
}
.tab.active {
  display: block;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  padding: 2px;
  border: 1px solid #4e342e;
}
th {
  background-color: #795548;
  color: #fff8e1;
}
input {
  padding: 4px;
  border: 1px solid #4e342e;
  border-radius: 3px;
  background-color: #efebe9;
  color: #3e2723;
}
.small-btn {
  background-color: #a1887f;
  color: #3e2723;
  padding: 3px 6px;
  border-radius: 3px;
}
`;
}

function element(tag,parent,id,text,listener){
let e;
if(parent) e=parent.appendChild(document.createElement(tag));
else       e=document.body.appendChild(document.createElement(tag));
if(id)e.id=id;
if(text)e.textContent=text;
if(listener)e.addEventListener('click',listener);
return e;
}

}
</script> </html>
